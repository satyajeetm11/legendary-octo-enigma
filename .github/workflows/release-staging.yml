name: "Release Staging"

on:
  workflow_dispatch:
  push:
    branches:
      - staging

concurrency:
  group: release-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release-id: ${{ steps.create-release.outputs.result }}
      version: ${{ steps.get-version.outputs.version }}
      tag: ${{ steps.get-version.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get staging version and tag
        id: get-version
        shell: bash
        run: |
          BASE_VERSION=$(grep -o '"version": "[^"]*"' frontend/src-tauri/tauri.staging.conf.json | cut -d'"' -f4)
          echo "Base version from tauri.staging.conf.json: $BASE_VERSION"

          git fetch --tags

          LATEST_STAGING_MINOR=0
          for tag in $(git tag -l "staging-v${BASE_VERSION}.*" | sed -E 's/^staging-v'"${BASE_VERSION}"'\.//' | sort -n); do
            if [[ "$tag" =~ ^[0-9]+$ ]]; then
              LATEST_STAGING_MINOR=$tag
            fi
          done

          NEXT_MINOR=$((LATEST_STAGING_MINOR + 1))
          VERSION="${BASE_VERSION}.${NEXT_MINOR}"
          TAG="staging-v${VERSION}"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Using staging tag: ${TAG}"

      - name: Create Draft Prerelease
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `${{ steps.get-version.outputs.tag }}`,
              name: `Meeting Assistant Staging v${{ steps.get-version.outputs.version }}`,
              draft: false,
              prerelease: true,
              generate_release_notes: true
            })
            console.log(`Created staging draft release with ID: ${data.id}`)
            return data.id

  build-macos-staging:
    needs: create-release
    permissions:
      contents: write
    runs-on: macos-14
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Install frontend dependencies
        run: |
          cd frontend
          pnpm install --no-frozen-lockfile

      - name: Build llama-helper sidecar
        run: |
          cargo build --release -p llama-helper --features metal
          mkdir -p frontend/src-tauri/binaries
          cp target/release/llama-helper frontend/src-tauri/binaries/llama-helper-aarch64-apple-darwin

      - name: Build macOS staging app (unsigned)
        run: |
          cd frontend
          pnpm tauri build --target aarch64-apple-darwin --config src-tauri/tauri.staging.conf.json

      - name: Upload macOS assets to staging release
        run: |
          TAG="${{ needs.create-release.outputs.tag }}"
          DMG_PATH=$(find target/aarch64-apple-darwin/release/bundle/dmg -name "*.dmg" | head -1)
          APP_TAR_PATH=$(find target/aarch64-apple-darwin/release/bundle/macos -name "*.app.tar.gz" | head -1)

          if [ -z "$DMG_PATH" ]; then
            echo "No DMG produced, failing build."
            exit 1
          fi

          gh release upload "$TAG" "$DMG_PATH" --clobber

          if [ -n "$APP_TAR_PATH" ]; then
            gh release upload "$TAG" "$APP_TAR_PATH" --clobber
          fi

  release-summary:
    needs: [create-release, build-macos-staging]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Summary
        run: |
          echo "## Staging Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ needs.create-release.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.create-release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This staging build is unsigned to simplify setup." >> $GITHUB_STEP_SUMMARY
          echo "Updater manifest publishing is disabled until signing secrets are configured." >> $GITHUB_STEP_SUMMARY
