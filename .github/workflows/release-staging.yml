name: "Release Staging"

on:
  workflow_dispatch:
  push:
    branches:
      - staging

concurrency:
  group: release-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release-id: ${{ steps.create-release.outputs.result }}
      version: ${{ steps.get-version.outputs.version }}
      tag: ${{ steps.get-version.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get staging version and tag
        id: get-version
        shell: bash
        run: |
          BASE_VERSION=$(grep -o '"version": "[^"]*"' frontend/src-tauri/tauri.staging.conf.json | cut -d'"' -f4)
          echo "Base version from tauri.staging.conf.json: $BASE_VERSION"

          git fetch --tags

          LATEST_STAGING_MINOR=0
          for tag in $(git tag -l "staging-v${BASE_VERSION}.*" | sed -E 's/^staging-v'"${BASE_VERSION}"'\.//' | sort -n); do
            if [[ "$tag" =~ ^[0-9]+$ ]]; then
              LATEST_STAGING_MINOR=$tag
            fi
          done

          NEXT_MINOR=$((LATEST_STAGING_MINOR + 1))
          VERSION="${BASE_VERSION}.${NEXT_MINOR}"
          TAG="staging-v${VERSION}"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Using staging tag: ${TAG}"

      - name: Create Draft Prerelease
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `${{ steps.get-version.outputs.tag }}`,
              name: `Meeting Assistant Staging v${{ steps.get-version.outputs.version }}`,
              draft: false,
              prerelease: true,
              generate_release_notes: true
            })
            console.log(`Created staging draft release with ID: ${data.id}`)
            return data.id

  build-all-platforms:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "windows-latest"
            args: "--config src-tauri/tauri.staging.conf.json"
            target: "x86_64-pc-windows-msvc"
    uses: ./.github/workflows/build.yml
    with:
      platform: ${{ matrix.platform }}
      target: ${{ matrix.target }}
      build-args: ${{ matrix.args }}
      sign-binaries: false
      asset-prefix: "meeting-assistant-staging"
      upload-artifacts: false
      release-id: ${{ needs.create-release.outputs.release-id }}
    secrets: inherit

  release-summary:
    needs: [create-release, build-all-platforms]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Summary
        run: |
          echo "## Staging Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ needs.create-release.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.create-release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This staging build is unsigned to simplify setup." >> $GITHUB_STEP_SUMMARY
          echo "Updater manifest publishing is disabled until signing secrets are configured." >> $GITHUB_STEP_SUMMARY
